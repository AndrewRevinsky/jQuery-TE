/*!
 * http://jqueryte.com
 * jQuery TE 1.0.7
 * Copyright (C) 2012, Fatih Koca (fatihkoca@me.com), AUTHOR.txt (http://jqueryte.com/about)
 * This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.
This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
You should have received a copy of the GNU General Public License along with this library; if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
*/
(function(e){e.fn.jqte=function(t){function r(e,t,n,r,s,o){return i.push({name:e,cls:t,command:n,key:r,tag:s,emphasis:o})}var n=e.extend({css:"jqte",b:true,i:true,u:true,ol:true,ul:true,sub:true,sup:true,outdent:true,indent:true,strike:true,link:true,unlink:true,remove:true,rule:true},t);var i=[];r("b","bold","Bold","B",["b","strong"],true);r("i","italic","Italic","I",["i","em"],true);r("u","underline","Underline","U",["u"],true);r("ol","orderedlist","insertorderedlist","¾",["ol"],true);r("ul","unorderedlist","insertunorderedlist","¼",["ul"],true);r("sub","subscript","subscript","(",["sub"],true);r("sup","superscript","superscript","&",["sup"],true);r("outdent","outdent","outdent","%",["blockquote"],false);r("indent","indent","indent","'",["blockquote"],true);r("strike","strike","strikeThrough","L",["strike"],true);r("link","link","createlink","K",["a"],true);r("unlink","unlink","unlink","N",["a"],false);r("remove","remove","removeformat",".",[],false);r("rule","rule","inserthorizontalrule","H",["hr"],false);return this.each(function(){function f(e){var t,n,r=navigator.userAgent.toLowerCase(),i=null;if(window.getSelection){n=window.getSelection();if(n.getRangeAt){t=n.getRangeAt(0)}if(t){n.removeAllRanges();n.addRange(t)}if(e=="createlink")i=l(t);if(!r.match(/msie/))document.execCommand("StyleWithCSS",false,false);document.execCommand(e,false,i)}else if(document.selection&&document.selection.createRange&&document.selection.type!="None"){t=document.selection.createRange();if(e=="createlink")i=l(t);t.execCommand(e,false,i)}}function l(e){thisSelected=c();thisTagName=thisSelected.prop("tagName").toLowerCase();thisHrefLink="http://";if(thisTagName=="a"&&thisSelected.is("[href]"))thisHrefLink=thisSelected.attr("href");return prompt("URL:",thisHrefLink)}function h(){var e=o.html().replace(/<p><\/p>/g,"").replace(/ /g," ").replace(/<p> <\/p>/g,""),n,r;n=[/\<div>(.*?)\<\/div>/ig,/\<br>(.*?)\<br>/ig,/\<br\/>(.*?)\<br\/>/ig,/\<strong>(.*?)\<\/strong>/ig,/\<em>(.*?)\<\/em>/ig];r=["<p>$1</p>","<p>$1</p>","<p>$1</p>","<b>$1</b>","<i>$1</i>"];for(var i=0;i<n.length;i++){e=e.replace(n[i],r[i])}t.val(o.html())}function p(t){var n=false,r=c(),i,s;e.each(t,function(t,o){i=r.prop("tagName").toLowerCase();s=r.attr("style");if(i==o)n=true;else{r.parents().each(function(){i=e(this).prop("tagName").toLowerCase();if(i==o)n=true})}});return n}function d(t){for(var r=0;r<i.length;r++){if(n[i[r].name]&&i[r].emphasis)p(i[r].tag)?s.find("."+i[r].cls).addClass(u):e("."+i[r].cls).removeClass(u)}}var t=e(this);t.hide().before('<div class="'+n.css+'" ></div>');var r=t.prev("."+n.css);r.html('<div class="'+n.css+"_Panel"+'"></div> <div class="'+n.css+"_Content"+'"></div>');var s=r.find("."+n.css+"_Panel");var o=r.find("."+n.css+"_Content");var u=n.css+"_Active";o.attr("contenteditable","true").html(t.val());e.ctrl=function(e,t,n){o.keydown(function(r){if(!n)n=[];if(r.keyCode==e.charCodeAt(0)&&r.ctrlKey){t.apply(this,n);return false}})};s.bind("selectstart mousedown",function(e){e.preventDefault()});for(var a=0;a<i.length;a++){if(n[i[a].name]){s.append('<a class="'+i[a].cls+'"></a>');s.find("a:last").data({tag:i[a].tag,command:i[a].command,emphasis:i[a].emphasis})}}var c=function(){var t,n;if(window.getSelection){n=getSelection();t=n.anchorNode}if(!t&&document.selection){n=document.selection;var r=n.getRangeAt?n.getRangeAt(0):n.createRange();t=r.commonAncestorContainer?r.commonAncestorContainer:r.parentElement?r.parentElement():r.item(0)}if(t){return t.nodeName=="#text"?e(t.parentNode):e(t)}};s.find("a").click(function(){if(o.not(":focus"))o.focus();f(e(this).data("command"));e(this).data("emphasis")==true&&!e(this).hasClass(u)?e(this).addClass(u):e(this).removeClass(u);h()});o.bind("mouseup keyup",d).bind("keypress keyup keydown drop cut copy paste DOMCharacterDataModified DOMSubtreeModified",function(){e(this).trigger("change")}).bind("change",function(){setTimeout(h,0)}).keydown(function(e){for(var t=0;t<i.length;t++){if(n[i[t].name]){if(e.keyCode==i[t].key.charCodeAt(0)&&e.ctrlKey){f(i[t].command);return false}}}}).focusout(function(){s.find("a").removeClass(u)})})}})(jQuery)